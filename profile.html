<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Chitralaya</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&family=Playfair+Display&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="chitra.css?v=6" />
    <script src="script.js"></script>
</head>

<body>
    <div class="header-container">
        <div class="navbar">
            <div class="logo">
                <span>‡§ö‡§ø‡§§‡•ç‡§∞‡§æ‡§≤‡§Ø|</span><span class="en">Chitralaya</span
                ><span class="icon">üé®</span>
            </div>

            <div class="nav-links">
                <a href="main.html#home">Home</a>
                <a href="main.html#gallery">Gallery</a>
                <a href="main.html#about">About</a>
                <a href="main.html#contact">Contact</a>
            </div>
        </div>

        <!-- User Actions -->
        <div class="user-actions">
            <a href="profile.html" class="user-action-btn" id="user-link">
                <img src="assets/user.png" alt="Profile" class="icon-img">
                <span id="user-text">Login</span>
            </a>
            <a href="cart.html" class="user-action-btn cart-btn">
                <img src="assets/shopping-cart.png" alt="Cart" class="icon-img">
                <span>Cart</span>
                <span class="cart-count" id="cart-count">0</span>
            </a>
        </div>
    </div>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="main.html">Home</a> ‚Ä∫ <span>Profile</span>
    </div>

    <main class="main-content">
        <div class="container">
            <!-- Profile Content -->
            <div class="profile-container" id="profile-content">
                <div class="profile-header">
                    <h1>My Profile</h1>
                    <p>Manage your account information and preferences</p>
                </div>

                <div class="profile-content">
                    <div class="profile-card">
                        <div class="profile-info">
                            <div class="profile-avatar">
                                <img src="assets/user.png" alt="Profile Avatar" id="profile-avatar">
                            </div>
                            <div class="profile-details">
                                <h2 id="profile-name">Loading...</h2>
                                <p id="profile-email">Loading...</p>
                            </div>
                        </div>
                        
                        <div class="profile-actions">
                            <button class="btn-primary" onclick="manageAddress()">Manage Address</button>
                            <button class="btn-secondary" onclick="viewOrders()">Your Orders</button>
                            <button class="btn-danger" onclick="logout()">Logout</button>
                        </div>
                    </div>
                        </div>
                    </div>

            <!-- Orders Content -->
            <div class="profile-container" id="orders-content" style="display: none;">
                <div class="profile-header">
                    <button class="back-btn" onclick="backToProfile()">‚Üê Back to Profile</button>
                    <h1>Your Orders</h1>
                    <p>Track your beautiful artwork purchases</p>
                </div>
                
                <div class="orders-container" id="orders-container">
                    <div class="loading-message" id="orders-loading">
                        <p>Loading your orders...</p>
                    </div>
                </div>
            </div>

            <!-- Addresses Content -->
            <div class="profile-container" id="addresses-content" style="display: none;">
                <div class="profile-header">
                    <button class="back-btn" onclick="backToProfile()">‚Üê Back to Profile</button>
                    <h1>Manage Addresses</h1>
                    <p>Save and manage your shipping addresses</p>
                </div>
                
                <div class="addresses-container">
                    <div class="addresses-actions">
                        <button class="btn-primary" onclick="showAddAddressForm()">Add New Address</button>
                    </div>
                    
                    <div class="addresses-list" id="addresses-list">
                        <div class="loading-message" id="addresses-loading">
                            <p>Loading your addresses...</p>
                        </div>
                    </div>
                    
                    <!-- Add/Edit Address Form -->
                    <div class="address-form-container" id="address-form-container" style="display: none;">
                        <div class="address-form-header">
                            <h3 id="address-form-title">Add New Address</h3>
                            <button class="btn-secondary" onclick="hideAddAddressForm()">Cancel</button>
                        </div>
                        
                        <form id="address-form" class="address-form">
                            <div class="form-group">
                                <label for="address-name">Address Name *</label>
                                <input type="text" id="address-name" name="name" required placeholder="e.g., Home, Office">
                            </div>
                            
                            <div class="form-group">
                                <label for="address-fullName">Full Name *</label>
                                <input type="text" id="address-fullName" name="fullName" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="address-email">Email Address *</label>
                                <input type="email" id="address-email" name="email" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="address-phone">Phone Number *</label>
                                <input type="tel" id="address-phone" name="phone" required value="+91">
                            </div>
                            
                            <div class="form-group">
                                <label for="address-address">Complete Address *</label>
                                <textarea id="address-address" name="address" required rows="3" placeholder="House/Flat No., Street, Area, Landmark"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="address-city">City *</label>
                                <input type="text" id="address-city" name="city" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="address-state">State *</label>
                                <input type="text" id="address-state" name="state" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="address-pincode">PIN Code *</label>
                                <input type="text" id="address-pincode" name="pincode" required pattern="[0-9]{6}" placeholder="6-digit PIN code">
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="address-isDefault" name="isDefault">
                                    Set as default address
                                </label>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn-primary">Save Address</button>
                                <button type="button" class="btn-secondary" onclick="hideAddAddressForm()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>


    <footer class="footer" id="about">
        <div class="footer-content">
            <div class="footer-section">
                <h3>About Chitralaya</h3>
                <p>Welcome to Chitralaya ‚Äî where colors speak. We showcase the original artworks created by my mother, each piece crafted with love and creativity. All artworks displayed here are available for purchase directly through our site.</p>
            </div>
            
            <div class="footer-section" id="contact">
                <h3>Contact Us</h3>
                <p>Get in touch with us for any inquiries about our artwork collection.</p>
                <div class="social-links">
                    <a href="mailto:mannu131376@gmail.com?subject=Inquiry from Chitralaya Website&body=Hello, I am interested in your artwork collection. Please contact me with more information." class="social-link">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                        <span>Email</span>
                    </a>
                    <a href="https://instagram.com/pratishtha0605" class="social-link">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                        <span>Instagram</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Chitralaya. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Profile page specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Check user login status for header button
            if (typeof checkUserStatus === 'function') {
                checkUserStatus();
            }
            
            loadProfileData();
        });

        async function loadProfileData() {
            const token = localStorage.getItem('authToken');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!token || !currentUser) {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
                return;
            }

            try {
                // Load user profile data
                const response = await fetch(`${window.API_BASE_URL}/auth/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const user = data.data.user;
                    updateProfileDisplay(user);
                } else {
                    console.error('Failed to load profile:', data.message);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                // Use cached user data if API fails
                if (currentUser) {
                    updateProfileDisplay(currentUser);
                }
            }
        }

        function updateProfileDisplay(user) {
            document.getElementById('profile-name').textContent = `${user.firstname} ${user.lastname}`;
            document.getElementById('profile-email').textContent = user.email;
        }



        function viewOrders() {
            // Hide profile content
            document.getElementById('profile-content').style.display = 'none';
            
            // Show orders content
            document.getElementById('orders-content').style.display = 'block';
            
            // Load orders
            loadUserOrders();
        }

        function backToProfile() {
            // Hide orders content
            document.getElementById('orders-content').style.display = 'none';
            
            // Hide addresses content
            document.getElementById('addresses-content').style.display = 'none';
            
            // Show profile content
            document.getElementById('profile-content').style.display = 'block';
        }

        async function loadUserOrders() {
            try {
                const token = localStorage.getItem('authToken');
                console.log('Token found:', token ? 'Yes' : 'No');
                
                if (!token) {
                    document.getElementById('orders-container').innerHTML = '<div class="empty-state"><p>Please login to view your orders</p></div>';
                    return;
                }

                console.log('Fetching orders from API...');
                const response = await fetch(`${window.API_BASE_URL}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Orders data:', data);
                    displayOrders(data.data.orders);
                } else {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    document.getElementById('orders-container').innerHTML = `<div class="error-message"><p>Failed to load orders: ${errorData.message || 'Unknown error'}</p></div>`;
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('orders-container').innerHTML = `<div class="error-message"><p>Error loading orders: ${error.message}</p></div>`;
            }
        }

        function displayOrders(orders) {
    const container = document.getElementById('orders-container');
    
    if (!orders || orders.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No orders found</p></div>';
        return;
    }

           const ordersHTML = orders.map(order => {
               const firstItem = order.items[0];
               const hasMultipleItems = order.items.length > 1;
               const additionalCount = order.items.length - 1;
               
               // Calculate total quantity of all items
               const totalQuantity = order.items.reduce((sum, item) => sum + item.quantity, 0);
               
               return `
                   <div class="order-card" style="margin-bottom: 30px;">
                       <!-- Order Preview -->
                       <div class="order-preview">
                           <div class="order-image">
                               <img src="${firstItem.product.images[0]}" 
                                    alt="${firstItem.product.name}">
                               ${hasMultipleItems ? `<div class="additional-count">+${additionalCount}</div>` : ''}
                           </div>

                           <div class="order-info">
                               <h3>
                                   ${firstItem.product.name}
                                   ${hasMultipleItems ? `<span class="title-badge">+${additionalCount} more</span>` : ''}
                               </h3>
                               <p class="order-artist">Artist: ${firstItem.product.artist}</p>
                               <p class="order-category">Category: ${firstItem.product.category}</p>
                               <p class="order-quantity">Total Quantity: ${totalQuantity}</p>
                               <div class="order-subtotal">
                                   <p>Total Amount: ‚Çπ${order.totalAmount.toLocaleString()}</p>
                               </div>
                           </div>

                           <div class="order-right-section">
                               <div class="order-actions">
                                   <button class="btn-secondary" onclick="toggleOrderDetails('${order._id}')">
                                       View Details
                                   </button>
                               </div>
                               
                               <div class="order-status">
                                   <span class="status-label">Order Status:</span>
                                   <span class="status-value status-${order.orderStatus || 'pending'}">${(order.orderStatus || 'pending').charAt(0).toUpperCase() + (order.orderStatus || 'pending').slice(1)}</span>
                               </div>
                               
                               <div class="payment-status">
                                   <span class="status-label">Payment Status:</span>
                                   <span class="status-value payment-${order.paymentStatus || 'pending'}">${(order.paymentStatus || 'pending').charAt(0).toUpperCase() + (order.paymentStatus || 'pending').slice(1)}</span>
                               </div>
                           </div>
                </div>

                <!-- Order Details (hidden until expanded) -->
                <div class="order-details" id="details-${order._id}" style="display: none;">
                    
                    <div class="order-items-list">
                        <h4>Ordered Paintings (${order.items.length} item${order.items.length > 1 ? 's' : ''})</h4>
                        <ul class="ordered-list">
                            ${order.items.map(item => `
                                <li>
                                    <strong>${item.product.name}</strong> 
                                    ‚Äî Qty: ${item.quantity}, Price: ‚Çπ${item.price.toLocaleString()}
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <div class="order-shipping">
                        <h4>Shipping Address</h4>
                        <p><strong>${order.shippingAddress.fullName}</strong></p>
                        <p>${order.shippingAddress.address}</p>
                        <p>${order.shippingAddress.city}, ${order.shippingAddress.state} ${order.shippingAddress.pincode}</p>
                        <p>Phone: ${order.shippingAddress.phone}</p>
                    </div>

                    ${order.notes ? `
                        <div class="order-notes">
                            <h4>Order Notes</h4>
                            <p>${order.notes}</p>
                        </div>
                    ` : ''}

                    <div class="order-footer">
                        <p><strong>Payment Method:</strong> ${order.paymentMethod}</p>
                        <p><strong>Total Amount:</strong> ‚Çπ${order.totalAmount.toLocaleString()}</p>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = ordersHTML;
}


        function toggleOrderDetails(orderId) {
            const detailsElement = document.getElementById(`details-${orderId}`);
            const button = event.target;
            
            if (detailsElement.style.display === 'none' || detailsElement.style.display === '') {
                detailsElement.style.display = 'block';
                button.textContent = 'Hide Details';
            } else {
                detailsElement.style.display = 'none';
                button.textContent = 'View Details';
            }
        }


        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear local storage
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                
                // Redirect to home page
                window.location.href = 'main.html';
            }
        }

        // Address Management Functions
        function manageAddress() {
            // Hide profile content
            document.getElementById('profile-content').style.display = 'none';
            
            // Show addresses content
            document.getElementById('addresses-content').style.display = 'block';
            
            // Load addresses
            loadUserAddresses();
        }

        async function loadUserAddresses() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    document.getElementById('addresses-list').innerHTML = '<div class="empty-state"><p>Please login to manage addresses</p></div>';
                    return;
                }

                const response = await fetch(`${window.API_BASE_URL}/addresses`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayAddresses(data.data.addresses);
                } else {
                    const errorData = await response.json();
                    document.getElementById('addresses-list').innerHTML = `<div class="error-message"><p>Failed to load addresses: ${errorData.message || 'Unknown error'}</p></div>`;
                }
            } catch (error) {
                console.error('Error loading addresses:', error);
                document.getElementById('addresses-list').innerHTML = `<div class="error-message"><p>Error loading addresses: ${error.message}</p></div>`;
            }
        }

        function displayAddresses(addresses) {
            const container = document.getElementById('addresses-list');
            
            if (!addresses || addresses.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No saved addresses found. Add your first address!</p></div>';
                return;
            }

            const addressesHTML = addresses.map(address => `
                <div class="address-card">
                    <div class="address-header">
                        <h4>${address.name} ${address.isDefault ? '<span class="default-badge">Default</span>' : ''}</h4>
                        <div class="address-actions">
                            <button class="btn-secondary" onclick="editAddress('${address._id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteAddress('${address._id}')">Delete</button>
                            ${!address.isDefault ? `<button class="btn-primary" onclick="setDefaultAddress('${address._id}')">Set Default</button>` : ''}
                        </div>
                    </div>
                    <div class="address-details">
                        <p><strong>${address.fullName}</strong></p>
                        <p>${address.address}</p>
                        <p>${address.city}, ${address.state} ${address.pincode}</p>
                        <p>Phone: ${address.phone}</p>
                        <p>Email: ${address.email}</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = addressesHTML;
        }

        function showAddAddressForm() {
            document.getElementById('address-form-container').style.display = 'block';
            document.getElementById('address-form-title').textContent = 'Add New Address';
            document.getElementById('address-form').reset();
            document.getElementById('address-phone').value = '+91';
            document.getElementById('address-form').setAttribute('data-address-id', '');
        }

        function hideAddAddressForm() {
            document.getElementById('address-form-container').style.display = 'none';
        }

        function editAddress(addressId) {
            // Find the address data from the displayed addresses
            const addressCard = event.target.closest('.address-card');
            const addressName = addressCard.querySelector('h4').textContent.replace(' Default', '').trim();
            const addressDetails = addressCard.querySelector('.address-details');
            
            // Extract address data from the displayed text
            const fullName = addressDetails.querySelector('p:first-child strong').textContent;
            const addressText = addressDetails.querySelector('p:nth-child(2)').textContent;
            const cityStatePincode = addressDetails.querySelector('p:nth-child(3)').textContent;
            const phone = addressDetails.querySelector('p:nth-child(4)').textContent.replace('Phone: ', '');
            const email = addressDetails.querySelector('p:nth-child(5)').textContent.replace('Email: ', '');
            
            // Parse city, state, pincode
            const cityStatePincodeParts = cityStatePincode.split(', ');
            const city = cityStatePincodeParts[0];
            const statePincode = cityStatePincodeParts[1].split(' ');
            const state = statePincode[0];
            const pincode = statePincode[1];
            
            // Fill the form
            document.getElementById('address-name').value = addressName;
            document.getElementById('address-fullName').value = fullName;
            document.getElementById('address-email').value = email;
            document.getElementById('address-phone').value = phone;
            document.getElementById('address-address').value = addressText;
            document.getElementById('address-city').value = city;
            document.getElementById('address-state').value = state;
            document.getElementById('address-pincode').value = pincode;
            document.getElementById('address-isDefault').checked = addressCard.querySelector('.default-badge') !== null;
            
            // Show form
            document.getElementById('address-form-container').style.display = 'block';
            document.getElementById('address-form-title').textContent = 'Edit Address';
            document.getElementById('address-form').setAttribute('data-address-id', addressId);
        }

        async function deleteAddress(addressId) {
            if (!confirm('Are you sure you want to delete this address?')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${window.API_BASE_URL}/addresses/${addressId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Address deleted successfully!');
                    loadUserAddresses(); // Reload addresses
                } else {
                    alert(`Error deleting address: ${data.message}`);
                }
            } catch (error) {
                console.error('Error deleting address:', error);
                alert('Error deleting address');
            }
        }

        async function setDefaultAddress(addressId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${window.API_BASE_URL}/addresses/${addressId}/default`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Default address updated successfully!');
                    loadUserAddresses(); // Reload addresses
                } else {
                    alert(`Error setting default address: ${data.message}`);
                }
            } catch (error) {
                console.error('Error setting default address:', error);
                alert('Error setting default address');
            }
        }

        // Handle address form submission
        document.getElementById('address-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const token = localStorage.getItem('authToken');
                console.log('Token found:', token ? 'Yes' : 'No');
                
                if (!token) {
                    alert('Please login to save addresses');
                    return;
                }

                const formData = new FormData(this);
                const addressData = {
                    name: formData.get('name'),
                    fullName: formData.get('fullName'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    address: formData.get('address'),
                    city: formData.get('city'),
                    state: formData.get('state'),
                    pincode: formData.get('pincode'),
                    isDefault: formData.get('isDefault') === 'on'
                };

                console.log('Address data to send:', addressData);

                const addressId = this.getAttribute('data-address-id');
                const isEdit = addressId && addressId !== '';

                const url = isEdit ? `${window.API_BASE_URL}/addresses/${addressId}` : `${window.API_BASE_URL}/addresses`;
                const method = isEdit ? 'PUT' : 'POST';

                console.log('Making request to:', url, 'with method:', method);

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(addressData)
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    alert(isEdit ? 'Address updated successfully!' : 'Address saved successfully!');
                    hideAddAddressForm();
                    loadUserAddresses(); // Reload addresses
                } else {
                    // Handle validation errors
                    if (data.errors && Array.isArray(data.errors)) {
                        const errorMessages = data.errors.map(err => err.msg || err.message).join('\n');
                        alert(`Validation Error:\n${errorMessages}`);
                    } else {
                        alert(`Error ${isEdit ? 'updating' : 'saving'} address: ${data.message}`);
                    }
                }
            } catch (error) {
                console.error('Error saving address:', error);
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    alert('Network error: Unable to connect to server. Please check if the server is running.');
                } else {
                    alert(`Error saving address: ${error.message}`);
                }
            }
        });
    </script>
    <script src="config.js"></script>
</body>
</html>
